from codrone_edu.drone import *
import time
SLEEP_TIME = 2
SPEED = 0.5

#====================== Change LED Color Start============
COLOR_BLUE = 1
COLOR_GREEN = 2
COLOR_RED = 3
COLOR_YELLOW = 4
COLOR_OFF = 0
#======================LED Color Definition End============

# -------- MAIN --------
def main():

    drone = Drone()
    drone.connect()
    drone.takeoff()
    stablize(SLEEP_TIME)
    
    print("===========after takeoff")
    passRedArch_GreenKeyhole()   # TODO_1 INPUT flight distance
    # set the blue color
    setLedColor(COLOR_BLUE) 
    #TODO Make another function to align the tunnel after green keyhole  
    '''
    flyThroughPanel() # TODO_2 Adjust flight distance, based on strategy, we may skip this mission
    goBackToPath() # TODO_2 Adjust flightxs2 distance, we may skip this mission
    stablize(SLEEP_TIME)
    '''
    setLedColor(COLOR_GREEN)
    goThroughTunnel()
    setLedColor(COLOR_OFF)
    #setLedColor(COLOR_RED)
    goThroughYellowKeyhole()
    goThroughBlueArch()
    drone.land()  
    
def stablize(time):
    time.sleep(time)

def setLedColor(color_code):
    #Change drone LED based on color_code.
    if color_code == COLOR_BLUE:        # Blue
        drone.set_drone_LED(0, 0, 255, 100)
    elif color_code == COLOR_GREEN:      # Green
        drone.set_drone_LED(0, 255, 0, 100)
    elif color_code == COLOR_RED:      # Red
        drone.set_drone_LED(255, 0, 0, 100)
    elif color_code == COLOR_YELLOW:      # Yellow
        drone.set_drone_LED(255, 255, 0, 100)
    else:                      # Off / default
        drone.set_drone_LED(0, 0, 0, 0)

def changeToHeight(target_height, change_speed):
    
    print("targetToHeight", target_height)
    current_Height = drone.get_height("cm")
    print("current:", current_Height)
 
    changeToHeight =  round((target_height - current_Height )/100, 2)
    print("=====changeToHeight:", changeToHeight)
    drone.move_distance(0, 0, changeToHeight, change_speed) # move down 0.50m at 0.50m/s
    stablize(SLEEP_TIME)

def passRedArch_GreenKeyhole():
    # raise to the green circle level,
    changeToHeight(100, SPEED) #TODO_1 Find height after takeoff and make sure it goes to panel
    print("===========after changeToHeight")
    #  then move forward to pass red arch adn green circle
    stablize(SLEEP_TIME)
    drone.avoid_wall(80,30) #approaching the ring
    #TODO_2 find out good time for first parameter
    changeToHeight(150,SPEED)#TODO_3 find optimal height to raise
    drone.move_forward(30, "cm", 25) #pass through the ring

    print("==========pass red arch and green circle")


def flyThroughPanel():
    ############## go through the panel start ==============
    # descend to the same level as circle on the panel
    changeToHeight(40, SPEED) #TODO find optimal height
    stablize(SLEEP_TIME)
    # move to pass the panel 
    drone.move_forward(30, "cm", 15) #TODO find optimal distance
    print("enter the circle")
    drone.move_right(40, "cm", 15)  #TODO find optimal distance
    print("exit the right circle")

def goBackToPath(): #figure out the best strategy
    # after exit, go back to the normal path
    drone.move_forward(30, "cm", 20) #TODO find optimal distance
    print("===========go through the panel")
    #stablize(SLEEP_TIME)
    drone.move_left(30, "cm", 20) #TODO find optimal distance
    #stablize(SLEEP_TIME)
    drone.move_forward(30, "cm", 20) #TODO find optimal distance
    stablize(SLEEP_TIME)
    print("==========before go through the tunnel")

def goThroughTunnel():
    #Since we are not doing the panel mission, we do not need to raise up.
    #changeToHeight(100, SPEED)  #TODO find optimal height
    #stablize(SLEEP_TIME)
    drone.move_forward(25, "cm", 15) # TODO find optimal distnace, pass the tunnel
    stablize(SLEEP_TIME)

def goThroughYellowKeyhole():
    #descend to the yellw circle
    drone.move_left(30, "cm", 20) #TODO find optimal distance
    changeToHeight(40, SPEED)
    setLedColor(COLOR_OFF)
    stablize(SLEEP_TIME)
    # go through the hole
    drone.move_right(30, "cm", 20) #TODO find optimal distance
    stablize(SLEEP_TIME)
    # back to original path
    drone.move_left(30, "cm", 20) #TODO find optimal distance
    drone.move_forward(30, "cm", 15) 
    stablize(SLEEP_TIME)
    drone.move_left(30, "cm", 15) 
    stablize(SLEEP_TIME)

def  goThroughBlueArch():
    print("goThroughBlueArch, start")
    #drone.move_forward(30, "cm", 20) 
    #stablize(SLEEP_TIME)
    #drone.move_left(30, "cm", 20) 
    #stablize(SLEEP_TIME)
    drone.move_forward(30, "cm", 20) 
    print("goThroughBlueArch, end")



# -------- Run Program --------
if __name__ == "__main__":
    main()
